<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Voice Detection Tester</title>

  <!-- Pico CSS (nice defaults, looks pro immediately) -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1/css/pico.min.css" />

  <style>
    :root { --border: rgba(120,120,120,.25); }
    body { padding: 24px 0; }
    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: 14px;
      padding: 22px;
      text-align: center;
      transition: all .15s ease;
      user-select: none;
    }
    .dropzone.dragover {
      border-color: var(--primary);
      background: rgba(100, 149, 237, .08);
      transform: translateY(-1px);
    }
    .muted { opacity: .75; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    pre {
      max-height: 360px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 14px;
      background: rgba(0,0,0,.03);
    }
    .pill {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      margin-right: 6px;
    }
    .ok { border-color: rgba(0, 170, 90, .35); }
    .warn { border-color: rgba(255, 165, 0, .45); }
    .err { border-color: rgba(220, 20, 60, .45); }
    .small { font-size: 13px; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .spinner {
      width: 14px; height: 14px;
      border: 2px solid rgba(120,120,120,.35);
      border-top-color: var(--primary);
      border-radius: 50%;
      display: inline-block;
      animation: spin .8s linear infinite;
      vertical-align: -2px;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
<main class="container">
  <nav style="margin-bottom: 18px;">
    <ul><li><strong>AI Voice Detection</strong> <span class="muted">Tester</span></li></ul>
    <ul><li class="muted small">Upload MP3 → Base64 → POST JSON</li></ul>
  </nav>

  <section class="card">
    <h3 style="margin-bottom:8px;">1) Configure</h3>
    <div class="row">
      <label>
        API Endpoint
        <input id="endpoint" type="text" value="http://127.0.0.1:5000/api/voice-detection" />
        <small class="muted">Example: http://127.0.0.1:5000/api/voice-detection</small>
      </label>

      <label>
        x-api-key
        <input id="apikey" type="password" placeholder="sk_....." />
        <small class="muted">Will be sent as request header: <code>x-api-key</code></small>
      </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>
        Language
        <select id="language">
          <option>Tamil</option>
          <option selected>English</option>
          <option>Hindi</option>
          <option>Malayalam</option>
          <option>Telugu</option>
        </select>
      </label>

      <label>
        Audio Format
        <input id="audioFormat" type="text" value="mp3" readonly />
        <small class="muted">Hackathon requires MP3</small>
      </label>
    </div>
  </section>

  <section class="card" style="margin-top:16px;">
    <h3 style="margin-bottom:8px;">2) Upload MP3</h3>

    <div id="dropzone" class="dropzone">
      <p style="margin:0;"><strong>Drag & drop</strong> an MP3 here</p>
      <p class="muted small" style="margin:6px 0 12px 0;">or</p>
      <div class="actions" style="justify-content:center;">
        <input id="file" type="file" accept="audio/mpeg,.mp3" />
        <button id="clearBtn" class="secondary" type="button">Clear</button>
      </div>
      <p id="fileInfo" class="muted small" style="margin-top:10px;">No file selected.</p>
      <div id="badges" style="margin-top:10px;"></div>
    </div>

    <div style="margin-top:14px;">
      <audio id="player" controls style="width:100%; display:none;"></audio>
    </div>

    <div class="actions" style="margin-top:14px;">
      <button id="sendBtn" type="button" disabled>Send to API</button>
      <span id="status" class="muted small"></span>
    </div>
  </section>

  <section class="card" style="margin-top:16px;">
    <h3 style="margin-bottom:8px;">3) Payload Preview</h3>
    <p class="muted small" style="margin-top:0;">
      We create Base64 using <code>FileReader.readAsDataURL()</code> and remove the data-url prefix (keep only raw Base64). :contentReference[oaicite:3]{index=3}
    </p>
    <pre id="payloadPreview">{}</pre>
  </section>

  <section class="card" style="margin-top:16px;">
    <h3 style="margin-bottom:8px;">4) Response</h3>
    <pre id="responsePreview">{}</pre>
  </section>

  <footer class="muted small" style="margin-top:18px;">
    Tip: If you open this file directly (file://), your browser may block requests (CORS).
    Run a tiny local server: <code>python -m http.server 8000</code> then open <code>http://localhost:8000</code>.
  </footer>
</main>

<script>
  const el = (id) => document.getElementById(id);

  const dropzone = el("dropzone");
  const fileInput = el("file");
  const player = el("player");
  const fileInfo = el("fileInfo");
  const badges = el("badges");
  const payloadPreview = el("payloadPreview");
  const responsePreview = el("responsePreview");
  const sendBtn = el("sendBtn");
  const clearBtn = el("clearBtn");
  const status = el("status");

  let currentFile = null;
  let currentBase64 = null; // raw base64 string (no prefix)

  function setBadge(text, cls) {
    const s = document.createElement("span");
    s.className = "pill " + (cls || "");
    s.textContent = text;
    badges.appendChild(s);
  }

  function resetUI() {
    currentFile = null;
    currentBase64 = null;
    fileInput.value = "";
    player.style.display = "none";
    player.src = "";
    fileInfo.textContent = "No file selected.";
    badges.innerHTML = "";
    payloadPreview.textContent = "{}";
    responsePreview.textContent = "{}";
    sendBtn.disabled = true;
    status.textContent = "";
  }

  async function fileToBase64Raw(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onerror = () => reject(new Error("FileReader failed"));
      fr.onload = () => {
        const dataUrl = String(fr.result || "");
        const parts = dataUrl.split(",");
        if (parts.length < 2) return reject(new Error("Unexpected data URL"));
        resolve(parts[1]); // raw base64
      };
      fr.readAsDataURL(file);
    });
  }

  function approxBytesFromBase64(b64) {
    // base64 length → bytes approx (ignore padding)
    const len = b64.length;
    const padding = (b64.endsWith("==") ? 2 : (b64.endsWith("=") ? 1 : 0));
    return Math.floor((len * 3) / 4) - padding;
  }

  async function loadFile(file) {
    resetUI();

    // basic validation
    const isMp3ByType = (file.type === "audio/mpeg");
    const isMp3ByName = (file.name || "").toLowerCase().endsWith(".mp3");
    if (!isMp3ByType && !isMp3ByName) {
      badges.innerHTML = "";
      setBadge("Not MP3", "err");
      fileInfo.textContent = "Please upload an MP3 file.";
      return;
    }

    currentFile = file;

    badges.innerHTML = "";
    setBadge("MP3", "ok");
    setBadge(`${(file.size / (1024 * 1024)).toFixed(2)} MB`, file.size > 8 * 1024 * 1024 ? "warn" : "ok");
    setBadge(file.type || "unknown mime", "muted");

    fileInfo.textContent = `Selected: ${file.name}`;

    // preview audio
    const url = URL.createObjectURL(file);
    player.src = url;
    player.style.display = "block";

    status.textContent = "Encoding to Base64…";
    try {
      const b64 = await fileToBase64Raw(file);
      currentBase64 = b64;

      const approxBytes = approxBytesFromBase64(b64);
      const approxMB = (approxBytes / (1024 * 1024)).toFixed(2);
      setBadge(`Base64 ~${approxMB} MB`, approxBytes > 10 * 1024 * 1024 ? "warn" : "ok");

      const payload = {
        language: el("language").value,
        audioFormat: "mp3",
        audioBase64: currentBase64
      };
      payloadPreview.textContent = JSON.stringify(
        { ...payload, audioBase64: `(base64 ${currentBase64.length} chars)` },
        null,
        2
      );

      sendBtn.disabled = false;
      status.textContent = "Ready.";
    } catch (e) {
      status.textContent = "Failed to encode Base64.";
      responsePreview.textContent = JSON.stringify({ status: "error", message: String(e) }, null, 2);
      setBadge("Base64 encode failed", "err");
    }
  }

  async function sendToApi() {
    if (!currentBase64) return;

    const endpoint = el("endpoint").value.trim();
    const apiKey = el("apikey").value.trim();
    const language = el("language").value;

    if (!endpoint) {
      responsePreview.textContent = JSON.stringify({ status: "error", message: "Endpoint is required" }, null, 2);
      return;
    }
    if (!apiKey) {
      responsePreview.textContent = JSON.stringify({ status: "error", message: "x-api-key is required" }, null, 2);
      return;
    }

    const payload = {
      language,
      audioFormat: "mp3",
      audioBase64: currentBase64
    };

    sendBtn.disabled = true;
    status.innerHTML = `<span class="spinner"></span>Calling API…`;
    responsePreview.textContent = "{}";

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey
        },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); }
      catch { json = { raw: text }; }

      responsePreview.textContent = JSON.stringify(
        { httpStatus: res.status, ...json },
        null,
        2
      );

      if (res.ok) {
        status.textContent = "Done.";
      } else {
        status.textContent = "API returned an error.";
      }
    } catch (e) {
      responsePreview.textContent = JSON.stringify({ status: "error", message: String(e) }, null, 2);
      status.textContent = "Request failed (check server + CORS).";
    } finally {
      sendBtn.disabled = false;
    }
  }

  // drag & drop events (DataTransfer files) :contentReference[oaicite:4]{index=4}
  ["dragenter", "dragover"].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.add("dragover");
    });
  });
  ["dragleave", "drop"].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove("dragover");
    });
  });
  dropzone.addEventListener("drop", (e) => {
    const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) loadFile(f);
  });

  fileInput.addEventListener("change", () => {
    const f = fileInput.files && fileInput.files[0];
    if (f) loadFile(f);
  });

  el("language").addEventListener("change", () => {
    if (!currentBase64) return;
    payloadPreview.textContent = JSON.stringify(
      { language: el("language").value, audioFormat: "mp3", audioBase64: `(base64 ${currentBase64.length} chars)` },
      null,
      2
    );
  });

  clearBtn.addEventListener("click", resetUI);
  sendBtn.addEventListener("click", sendToApi);

  resetUI();
</script>
</body>
</html>
